{"name":"rivalries","version":"1769953545515","created_version":"1769953545515","type":"VIEW","sql":"-- Epic Rivalries: The battles that define online chess\n\nWITH all_matchups AS (\n  SELECT\n    CASE WHEN white_username \u003c black_username THEN white_username ELSE black_username END as player_1,\n    CASE WHEN white_username \u003c black_username THEN black_username ELSE white_username END as player_2,\n    winner,\n    time_class,\n    end_time,\n    white_rating,\n    black_rating\n  FROM read_parquet('data/games_enriched.parquet')\n  WHERE winner IS NOT NULL\n)\n\nSELECT\n  player_1 || ' vs ' || player_2 as rivalry,\n  player_1,\n  player_2,\n  time_class,\n  COUNT(*) as total_battles,\n  SUM(CASE WHEN winner = player_1 THEN 1 ELSE 0 END) as p1_wins,\n  SUM(CASE WHEN winner = player_2 THEN 1 ELSE 0 END) as p2_wins,\n  SUM(CASE WHEN winner = player_1 THEN 1 ELSE 0 END) - SUM(CASE WHEN winner = player_2 THEN 1 ELSE 0 END) as win_differential,\n  ROUND(CAST(SUM(CASE WHEN winner = player_1 THEN 1 ELSE 0 END) AS DOUBLE) / COUNT(*), 3) as p1_win_rate,\n  -- Who dominates?\n  CASE \n    WHEN SUM(CASE WHEN winner = player_1 THEN 1 ELSE 0 END) \u003e SUM(CASE WHEN winner = player_2 THEN 1 ELSE 0 END) * 1.5 \n      THEN player_1 || ' DOMINATES'\n    WHEN SUM(CASE WHEN winner = player_2 THEN 1 ELSE 0 END) \u003e SUM(CASE WHEN winner = player_1 THEN 1 ELSE 0 END) * 1.5 \n      THEN player_2 || ' DOMINATES'\n    ELSE 'CLOSE RIVALRY'\n  END as rivalry_status,\n  MIN(end_time) as first_battle,\n  MAX(end_time) as last_battle\nFROM all_matchups\nGROUP BY player_1, player_2, time_class\nHAVING COUNT(*) \u003e= 50\nORDER BY total_battles DESC"}